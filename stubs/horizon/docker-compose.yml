services:
  horizon:
    image: launchpad-php:8.4
    container_name: launchpad-horizon
    volumes:
      # Mount the web app
      - ../web:/app
      # Mount Docker socket for CLI commands
      - /var/run/docker.sock:/var/run/docker.sock
      # Mount CLI binary
      - ${HOME}/.local/bin/launchpad:/usr/local/bin/launchpad:ro
      # Mount CLI config (needed for CLI commands)
      - ${HOME}/.config/launchpad:/home/launchpad/.config/launchpad
      # Mount projects directory (needed for provisioning)
      - ${HOME}/projects:/home/launchpad/projects
    environment:
      - HOME=/home/launchpad
      - REDIS_HOST=launchpad-redis
      - REDIS_PORT=6379
      - REVERB_HOST=launchpad-reverb
      - REVERB_PORT=8080
      - REVERB_SCHEME=http
    working_dir: /app
    command: php artisan horizon
    user: launchpad
    restart: unless-stopped
    networks:
      - launchpad
    healthcheck:
      test: ["CMD-SHELL", "php artisan horizon:status | grep -q running || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3

networks:
  launchpad:
    external: true
